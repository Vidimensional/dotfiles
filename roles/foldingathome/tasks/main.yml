---
- name: Create tmp path for Dockerbuild
  ansible.builtin.file:
    path: "{{ tmp_path }}/fah"
    state: directory
    mode: u=rwx,g=rx,o=rx

- name: Move Dockerfile build context path
  ansible.builtin.copy:
    src: "Dockerfile"
    dest: "{{ tmp_path }}/fah/Dockerfile"
    owner: "{{ ansible_facts['user_uid'] }}"
    group: "{{ ansible_facts['user_gid'] }}"
    mode: u=rwx,g=rx,o=rx

- name: Move config.xml to context path
  ansible.builtin.template:
    src: config.xml.j2
    dest: "{{ tmp_path }}/fah/config.xml"
    owner: "{{ ansible_facts['user_uid'] }}"
    group: "{{ ansible_facts['user_gid'] }}"
    mode: u=rwx,g=rx,o=rx

- name: Build foldingathome image
  community.docker.docker_image:
    build:
      path: "{{ tmp_path }}/fah/"
    name: foldingathome
    tag: latest
    source: build

- name: Create tmp path for Dockerbuild
  ansible.builtin.file:
    path: "{{ ansible_facts['user_dir'] }}/ContainerData/foldingathome"
    state: directory
    mode: u=rwx,g=rx,o=rx

- name: Deploy foldingathome container
  community.docker.docker_container:
    name: foldingathome
    image: foldingathome
    volumes:
      - "{{ ansible_facts['user_dir'] }}/ContainerData/foldingathome:/fahclient"



# 11:32:47:       CUDA: Not detected: Failed to open dynamic library 'libcuda.so': cannot open shared object file: No such file or directory
# 11:32:47:     OpenCL: Not detected: Failed to open dynamic library 'libOpenCL.so': cannot open shared object file: No such file or directory