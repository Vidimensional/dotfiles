---
- name: Install aws_ssm_plugin |Get aws_ssm_plugin current version
  ansible.builtin.command: session-manager-plugin --version
  register: ssm_plugin_current_version
  changed_when: false
  failed_when: false
  when: install_ssm_plugin

- name: Install aws_ssm_plugin
  when: |
    install_ssm_plugin and (
      ssm_plugin_current_version is failed or
      ssm_plugin_current_version.stdout != ssm_plugin_version|replace("+", ".")
    )
  block:
    - name: Install aws_ssm_plugin | Download .deb
      ansible.builtin.get_url:
        url: "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb"
        dest: "{{ tmp_path }}/session-manager-plugin.deb"
        owner: "{{ ansible_facts['user_uid'] }}"
        group: "{{ ansible_facts['user_gid'] }}"
        mode: u=rw,g=r,o=r

    - name: Install aws_ssm_plugin | Install .deb file
      ansible.builtin.apt:
        deb: "{{ tmp_path }}/session-manager-plugin.deb"
      become: true
